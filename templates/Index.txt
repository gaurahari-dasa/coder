<template>
    <Layout :menus :auth>
        <div class="flex flex-col gap-2 sm:gap-6 lg:gap-8">@@@ avatar_heading @@@
            <EntityCard class="px-4 sm:px-6 lg:px-8" :show="showAddForm">
                <h3 class="text-lg font-semibold text-slate-800">Add what (entity) ???</h3>
                <form class="relative" @submit.prevent="addEntity">
                    <FormGuard :allow="!formSaved">
                        <div class="grid grid-cols-4 gap-4">
                        @@@ form_controls_for_adding @@@
                        </div>
                    </FormGuard>
                    <div class="relative lg:mt-8 lg:gap-x-8 sm:mt-6 sm:gap-x-6 mt-2 gap-x-2 flex justify-center">
                        <ToastMessage message="Saved Successfully, Haribol!" :show="addForm.recentlySuccessful" />
                        <FormCancelButton @click="closeAddForm">Cancel</FormCancelButton>
                        <FormSubmitButton :disabled="addForm.processing || formSaved">Save</FormSubmitButton>
                    </div>
                </form>
            </EntityCard>
            <EntityCard class="px-4 sm:px-6 lg:px-8" :show="showEditForm">
                <h3 class="text-lg font-semibold text-slate-800">Edit what (entity) ???</h3>
                <form class="relative" @submit.prevent="updateEntity">
                    <div class="grid grid-cols-4 gap-4">
                    @@@ form_controls_for_editing @@@
                    </div>
                    <div class="relative lg:mt-8 lg:gap-x-8 sm:mt-6 sm:gap-x-6 mt-2 gap-x-2 flex justify-center">
                        <ToastMessage message="Saved Successfully, Haribol!" :show="editForm.recentlySuccessful" />
                        <FormCancelButton @click="closeEditForm">Cancel</FormCancelButton>
                        <FormSubmitButton :disabled="editForm.processing">Save</FormSubmitButton>
                    </div>
                </form>
            </EntityCard>

            <PaginatedDataTable class="px-4 sm:px-6 lg:px-8" title="what (entities) ???" :showAdd="addable"
                description="A list of all the what ???, Haribol"
                :headings=@@@ grid_headings @@@ :pageData="@@@ model_props @@@"
                :columns=@@@ grid_column_types @@@
                :fields=@@@ grid_fields @@@ :searchKey
                :sortableFields=@@@ grid_sortable_fields @@@ :sortField :sortDir
                @table-add="showAddForm = true; showEditForm = false;" @row-act="editRow" focusSearch :actionIcons />
        </div>
    </Layout>
</template>

<script setup>
import Layout from '../../components/Layout.vue';
import PaginatedDataTable from '../../components/PaginatedDataTable.vue';
@@@ vue_imports @@@
import { filterActions } from '../../utils';

import { computed, ref } from 'vue';
import { useForm } from '@inertiajs/vue3';
import { PencilSquareIcon } from '@heroicons/vue/24/outline';

const props = defineProps({
    menus: Array,
    auth: Object,
    privileges: Array,
    @@@ model_props @@@: Object,
    @@@ vue_props @@@
    searchKey: String,
    sortField: String,
    sortDir: String,
});

const actionIcons = computed(() => filterActions(props.privileges, {
    edit@@@ privy_suffix @@@: PencilSquareIcon,
}));

const addable = computed(() => {
    return props.privileges.indexOf('add@@@ privy_suffix @@@') !== -1;
});

const showAddForm = ref(false);
const showEditForm = ref(false);

const blanked = {
    @@@ blanked @@@
};
const addForm = useForm(@@@ add_form @@@);
const editForm = useForm(@@@ edit_form @@@);
const formSaved = ref(false);

function closeAddForm() {
    showAddForm.value = false;
    addForm.clearErrors();
    Object.assign(addForm, blanked);
    formSaved.value = false;
}

function closeEditForm() {
    showEditForm.value = false;
    editForm.clearErrors();
    editId = null;
}

function addEntity() {
    addForm.post('@@@ model_route @@@', {
        onSuccess: () => {
            addForm.clearErrors();
            formSaved.value = true;
        },
        preserveScroll: true,
    });
}

var editId = null;

function editRow(id) {
    @@@ edit_row @@@
    showEditForm.value = true;
    showAddForm.value = false;
}

function updateEntity() {
    editForm.patch(`@@@ model_route @@@/${editId}`, {
        onSuccess: () => editForm.clearErrors(),
        preserveScroll: true,
    });
}
</script>